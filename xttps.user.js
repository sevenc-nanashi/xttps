// ==UserScript==
// @name         Xttps
// @namespace    xttps
// @version      1.0.4
// @description  Make ttps:// links clickable in Twitter (or X)
// @author       Nanashi.
// @match        https://twitter.com/*
// @match        https://x.com/*
// @icon         https://raw.githubusercontent.com/sevenc-nanashi/xttps/main/static/128.png
// @updateURL    https://raw.githubusercontent.com/sevenc-nanashi/xttps/release/xttps.user.js
// ==/UserScript==
(()=>{var ce=Object.create;var N=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var U=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var me=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of de(t))!pe.call(e,s)&&s!==n&&N(e,s,{get:()=>t[s],enumerable:!(i=ue(t,s))||i.enumerable});return e};var he=(e,t,n)=>(n=e!=null?ce(fe(e)):{},me(t||!e||!e.__esModule?N(n,"default",{value:e,enumerable:!0}):n,e));var ie=U((Ie,ne)=>{"use strict";var m=function(e){if(e=e||{},this.Promise=e.Promise||Promise,this.queues=Object.create(null),this.domainReentrant=e.domainReentrant||!1,this.domainReentrant){if(typeof process>"u"||typeof process.domain>"u")throw new Error("Domain-reentrant locks require `process.domain` to exist. Please flip `opts.domainReentrant = false`, use a NodeJS version that still implements Domain, or install a browser polyfill.");this.domains=Object.create(null)}this.timeout=e.timeout||m.DEFAULT_TIMEOUT,this.maxOccupationTime=e.maxOccupationTime||m.DEFAULT_MAX_OCCUPATION_TIME,this.maxExecutionTime=e.maxExecutionTime||m.DEFAULT_MAX_EXECUTION_TIME,e.maxPending===1/0||Number.isInteger(e.maxPending)&&e.maxPending>=0?this.maxPending=e.maxPending:this.maxPending=m.DEFAULT_MAX_PENDING};m.DEFAULT_TIMEOUT=0;m.DEFAULT_MAX_OCCUPATION_TIME=0;m.DEFAULT_MAX_EXECUTION_TIME=0;m.DEFAULT_MAX_PENDING=1e3;m.prototype.acquire=function(e,t,n,i){if(Array.isArray(e))return this._acquireBatch(e,t,n,i);if(typeof t!="function")throw new Error("You must pass a function to execute");var s=null,l=null,r=null;typeof n!="function"&&(i=n,n=null,r=new this.Promise(function(d,v){s=d,l=v})),i=i||{};var c=!1,u=null,f=null,h=null,o=this,p=function(d,v,_){f&&(clearTimeout(f),f=null),h&&(clearTimeout(h),h=null),d&&(o.queues[e]&&o.queues[e].length===0&&delete o.queues[e],o.domainReentrant&&delete o.domains[e]),c||(r?v?l(v):s(_):typeof n=="function"&&n(v,_),c=!0),d&&o.queues[e]&&o.queues[e].length>0&&o.queues[e].shift()()},x=function(d){if(c)return p(d);u&&(clearTimeout(u),u=null),o.domainReentrant&&d&&(o.domains[e]=process.domain);var v=i.maxExecutionTime||o.maxExecutionTime;if(v&&(h=setTimeout(function(){o.queues[e]&&p(d,new Error("Maximum execution time is exceeded "+e))},v)),t.length===1){var _=!1;try{t(function(b,ae){_||(_=!0,p(d,b,ae))})}catch(b){_||(_=!0,p(d,b))}}else o._promiseTry(function(){return t()}).then(function(b){p(d,void 0,b)},function(b){p(d,b)})};if(o.domainReentrant&&process.domain&&(x=process.domain.bind(x)),!o.queues[e])o.queues[e]=[],x(!0);else if(o.domainReentrant&&process.domain&&process.domain===o.domains[e])x(!1);else if(o.queues[e].length>=o.maxPending)p(!1,new Error("Too many pending tasks in queue "+e));else{var w=function(){x(!0)};i.skipQueue?o.queues[e].unshift(w):o.queues[e].push(w);var a=i.timeout||o.timeout;a&&(u=setTimeout(function(){u=null,p(!1,new Error("async-lock timed out in queue "+e))},a))}var q=i.maxOccupationTime||o.maxOccupationTime;if(q&&(f=setTimeout(function(){o.queues[e]&&p(!1,new Error("Maximum occupation time is exceeded in queue "+e))},q)),r)return r};m.prototype._acquireBatch=function(e,t,n,i){typeof n!="function"&&(i=n,n=null);var s=this,l=function(c,u){return function(f){s.acquire(c,u,f,i)}},r=e.reduceRight(function(c,u){return l(u,c)},t);if(typeof n=="function")r(n);else return new this.Promise(function(c,u){r.length===1?r(function(f,h){f?u(f):c(h)}):c(r())})};m.prototype.isBusy=function(e){return e?!!this.queues[e]:Object.keys(this.queues).length>0};m.prototype._promiseTry=function(e){try{return this.Promise.resolve(e())}catch(t){return this.Promise.reject(t)}};ne.exports=m});var re=U((Me,oe)=>{"use strict";oe.exports=ie()});var S={name:"xttps",version:"1.0.4",description:"Make ttps:// links clickable in Twitter (or X)",homepage:"https://github.com/sevenc-nanashi/xttps",type:"module",scripts:{test:'echo "Error: no test specified" && exit 1',build:"node --loader ts-node/esm ./build.cts --pack",dev:'nodemon --ext mts,cts --exec "node --loader ts-node/esm ./build.cts"',lint:"eslint --ext .mjs,.mts,.cts,.ts .","lint:fix":"eslint --ext .mjs,.mts,.cts,.ts . --fix"},keywords:[],author:"",license:"ISC",devDependencies:{"@samrum/vite-plugin-web-extension":"^5.1.0","@types/adm-zip":"^0.5.5","@types/async-lock":"^1.4.2","@types/node":"^20.10.5","@types/webextension-polyfill":"^0.10.7","@typescript-eslint/eslint-plugin":"^6.15.0","@typescript-eslint/parser":"^6.15.0","adm-zip":"^0.5.10",esbuild:"^0.19.10",eslint:"^8.56.0","eslint-config-prettier":"^9.1.0","eslint-plugin-prettier":"^5.1.0",nodemon:"^3.0.2",prettier:"^3.1.1","ts-node":"^10.9.2",typescript:"^5.3.3"},dependencies:{"async-lock":"^1.4.0","vanjs-core":"^1.2.7"}};var I=Object,y,g=I.getPrototypeOf,M=document,O,A,E,X={isConnected:1},ge=1e3,P,F={},ve=g(X),B=g(g),V=(e,t,n,i)=>(e??(setTimeout(n,i),new Set)).add(t),G=(e,t,n)=>{let i=A;A=t;try{return e(n)}catch(s){return console.error(s),n}finally{A=i}},C=e=>e.filter(t=>t._dom?.isConnected),$=e=>P=V(P,e,()=>{for(let t of P)t._bindings=C(t._bindings),t._listeners=C(t._listeners);P=y},ge),D={get val(){return A?.add(this),this._val},get oldVal(){return A?.add(this),this._oldVal},set val(e){let t=this;if(e!==t._val){t._val=e;let n=[...t._listeners=C(t._listeners)];for(let i of n)H(i.f,i.s,i._dom),i._dom=y;t._bindings.length?O=V(O,t,Te):t._oldVal=e}}},z=e=>({__proto__:D,_val:e,_oldVal:e,_bindings:[],_listeners:[]}),W=e=>g(e??0)===D,_e=e=>W(e)?e.val:e,be=e=>W(e)?e.oldVal:e,T=(e,t)=>{let n=new Set,i={f:e},s=E;E=[];let l=G(e,n,t);l=(l??M).nodeType?l:new Text(l);for(let r of n)$(r),r._bindings.push(i);for(let r of E)r._dom=l;return E=s,i._dom=l},H=(e,t=z(),n)=>{let i=new Set,s={f:e,s:t};s._dom=n??E?.push(s)??X,t.val=G(e,i);for(let l of i)$(l),l._listeners.push(s);return t},J=(e,...t)=>{for(let n of t.flat(1/0)){let i=g(n??0),s=i===D?T(()=>n.val):i===B?T(n):n;s!=y&&e.append(s)}return e},ye=e=>(e._isBindingFunc=1,e),R=e=>new Proxy((t,...n)=>{let[i,...s]=g(n[0]??0)===ve?n:[{},...n],l=e?M.createElementNS(e,t):M.createElement(t);for(let[r,c]of I.entries(i)){let u=x=>x?I.getOwnPropertyDescriptor(x,r)??u(g(x)):y,f=t+","+r,h=F[f]??(F[f]=u(g(l))?.set??0),o=h?h.bind(l):l.setAttribute.bind(l,r),p=g(c??0);p===D?T(()=>(o(c.val),l)):p===B&&(!r.startsWith("on")||c._isBindingFunc)?T(()=>(o(c()),l)):o(c)}return J(l,...s)},{get:(t,n)=>t.bind(y,n)}),K=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),Te=()=>{let e=[...O].filter(t=>t._val!==t._oldVal);O=y;for(let t of new Set(e.flatMap(n=>n._bindings=C(n._bindings))))K(t._dom,T(t.f,t._dom)),t._dom=y;for(let t of e)t._oldVal=t._val},we=(e,t)=>K(e,T(t,e)),Q={add:J,_:ye,tags:R(),tagsNS:R,state:z,val:_e,oldVal:be,derive:H,hydrate:we};var{a:qe,style:Ee,span:L}=Q.tags,Z=()=>Ee({},`
      .xttps-link:hover {
        text-decoration: underline;
      }
      `),j="r-b88u0q",k=["css-1qaijid","r-bcqeeo","r-qvutc0","r-1tl8opc"],ee=(e,{bold:t=!1}={})=>L({class:"css-1qaijid r-bcqeeo r-qvutc0 r-1tl8opc"+(t?" "+j:""),style:"text-overflow: unset;"},e),Y=()=>L({"aria-hidden":"true",class:"css-1qaijid r-bcqeeo r-qvutc0 r-1tl8opc r-lrvibr",style:"text-overflow: unset;"},"\u2026"),te=e=>{let t=e.match(/https?:\/\/([^/]+)/);if(!t)return;let n=t[1],i=e.substring(t[0].length),s=n.length>=27,l=i.length>=16,r=s?n.substring(n.length-25):n,c=l?i.substring(0,14):i,u=c.length<=1?r:r+c;return qe({dir:"ltr",href:e,rel:"noopener noreferrer nofollow",target:"_blank",role:"link",class:"css-1qaijid r-bcqeeo r-qvutc0 r-poiln3 r-1loqt21 xttps-link",style:"color: rgb(29, 155, 240); text-overflow: unset;"},L({style:"text-overflow: unset; opacity: 0.5; font-size: 80%;"},e.startsWith("https://")?"ttps://":"ttp://"),s?Y:"",u,l?Y:"")};var se=he(re(),1),le=async()=>{let e=document.querySelector("main[role=main]");if(!e){setTimeout(le,100);return}document.head.appendChild(Z());let t=new se.default;new MutationObserver(async()=>{t.isBusy()||(await new Promise(i=>requestAnimationFrame(i)),t.acquire("replace",async()=>{let i=e.querySelectorAll("div[data-testid='tweetText']:not([data-xttps-replaced])");for(let s of Array.from(i)){s.setAttribute("data-xttps-replaced","true");let l=[[]];for(let r of Array.from(s.childNodes)){if(!(r instanceof HTMLSpanElement)){l.push([]);continue}k.every(c=>r.classList.contains(c))?l[l.length-1].push(r):l.push([])}for(let r of Array.from(l.filter(c=>c.length>0))){let c=r.map(a=>a.textContent).join("");if(!c)continue;let u=[],f=0;for(let a of r)u.push({start:f,length:a.textContent.length,type:a.classList.contains(j)?"bold":"text",text:a.textContent}),f+=a.textContent.length;let h=Array.from(c.matchAll(/ttps?:\/\/[^\s]+/g));if(h.length===0)continue;let o=[],p=0;for(let a of h){let q=u.filter(d=>d.start<a.index+a[0].length);if(q.length!==0){for(let d of q)d.start<a.index&&o.push({text:d.text.substring(0,a.index-d.start),type:d.type});p=a.index+a[0].length,o.push({text:a[0],type:"link"})}}let x=c.substring(p);x&&o.push({text:x,type:u[u.length-1].type}),console.debug(`Fixing ttps:
%c${o.map(a=>a.text).join("%c")}`,...o.map(a=>a.type==="link"?"color: #1d9bf0; text-decoration: underline; font-weight: auto;":a.type==="bold"?"color: auto; font-weight: bold; text-decoration: underline;":"color: auto; font-weight: auto; text-decoration: auto;"));let w=r[r.length-1].nextSibling;for(let a of o)a.type==="link"?s.insertBefore(te("h"+a.text),w):s.insertBefore(ee(a.text,{bold:a.type==="bold"}),w);r.forEach(a=>a.remove())}}}))}).observe(e,{childList:!0,subtree:!0})},Se=()=>{document.body.getAttribute("data-xttps-init")!=="true"&&(document.body.setAttribute("data-xttps-init","true"),console.log(`%c== Xttps ----------------------------------------
  Xttps / ${S.description}
  %cVersion: %cv${S.version}
  %cDeveloped by %cNanashi.
  %c${S.homepage}
%c--------------------------------------------------`,"color: #1d9bf0","color: auto","color: #1d9bf0","color: auto","color: #48b0d5","color: auto","color: #1d9bf0"),le())};Se();})();
